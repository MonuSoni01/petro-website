/* =========================================================================
   Petro Diwali â€“ Improved Cursor & Fireworks
   =======================================================================*/
(function(){
  // ---- Festive lights creation ----
  const bulbs = document.getElementById('petroBulbs');
  const bulbCount = Math.max(18, Math.floor(window.innerWidth / 56));
  for(let i=0;i<bulbCount;i++){
    const li = document.createElement('li');
    li.style.animationDelay = (Math.random()*1.2).toFixed(2)+'s';
    bulbs.appendChild(li);
  }

  // ---- Canvas setup ----
  const fwCanvas = document.getElementById('petroFireworks');
  const fctx = fwCanvas.getContext('2d');
  const cCanvas = document.getElementById('petroCursor');
  const cctx = cCanvas.getContext('2d');

  let W = fwCanvas.width = cCanvas.width = window.innerWidth;
  let H = fwCanvas.height = cCanvas.height = window.innerHeight;
  window.addEventListener('resize',()=>{
    W = fwCanvas.width = cCanvas.width = window.innerWidth;
    H = fwCanvas.height = cCanvas.height = window.innerHeight;
  });

  const COLORS = [
    'rgba(201,166,70,',   // gold
    'rgba(16,128,130,',   // teal
    'rgba(255,212,59,'    // yellow
  ];

  let rockets = [];
  let particles = [];
  const MAX_ROCKETS = 3;
  const MAX_PARTICLES = 200;

  function spawnRocket(){
    const x = Math.random()*W*0.9 + W*0.05;
    const y = H + 10;
    const vx = (Math.random()-0.5)*0.6; // slower drift
    const vy = -(4 + Math.random()*2);  // slower rise
    const color = COLORS[(Math.random()*COLORS.length)|0];
    rockets.push({x,y,vx,vy,life:0,color,peak: (H*0.3 + Math.random()*H*0.25)});
  }

  function explode(x,y,color){
    const count = 30;
    for(let i=0;i<count;i++){
      const angle = (Math.PI*2)*(i/count)+Math.random()*0.3;
      const speed = 1.2 + Math.random()*2.5;
      const vx = Math.cos(angle)*speed;
      const vy = Math.sin(angle)*speed;
      particles.push({x,y,vx,vy,alpha:1,decay:0.005+Math.random()*0.015,color});
    }
  }

  function tickFireworks(){
    fctx.clearRect(0,0,W,H);

    if(rockets.length < MAX_ROCKETS && Math.random() < 0.02) spawnRocket();

    for(let i=rockets.length-1;i>=0;i--){
      const r = rockets[i];
      r.x += r.vx;
      r.y += r.vy;
      r.vy += 0.03; // gravity
      fctx.beginPath();
      fctx.fillStyle = r.color + '0.8)';
      fctx.arc(r.x, r.y, 2.5, 0, Math.PI*2);
      fctx.fill();

      if(r.y < r.peak || r.vy > -0.2){
        explode(r.x, r.y, r.color);
        rockets.splice(i,1);
      }
    }

    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.02;
      p.vx *= 0.99; p.vy *= 0.99;
      p.alpha -= p.decay;
      if(p.alpha <= 0){particles.splice(i,1); continue;}
      const rad = 2.2 + (1-p.alpha)*3;
      const grad = fctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rad*3);
      grad.addColorStop(0, p.color + (p.alpha)+')');
      grad.addColorStop(1, p.color + '0)');
      fctx.beginPath();
      fctx.fillStyle = grad;
      fctx.arc(p.x, p.y, rad, 0, Math.PI*2);
      fctx.fill();
    }

    requestAnimationFrame(tickFireworks);
  }
  requestAnimationFrame(tickFireworks);

  /* ========= Improved Cursor Trail ========= */
  let trail = [];
  const TRAIL_MAX = 25;
  function addTrail(x,y){
    for(let i=0;i<2;i++){
      trail.push({x:x+(Math.random()*6-3), y:y+(Math.random()*6-3), alpha:1, size:3+Math.random()*3});
    }
    if(trail.length>TRAIL_MAX) trail.splice(0, trail.length-TRAIL_MAX);
  }

  window.addEventListener('pointermove', (e)=>{
    addTrail(e.clientX, e.clientY);
  });

  function tickCursor(){
    cctx.clearRect(0,0,W,H);
    for(let i=trail.length-1;i>=0;i--){
      const t = trail[i];
      t.alpha *= 0.94;
      t.y -= 0.2;
      const r = t.size;
      const g = cctx.createRadialGradient(t.x,t.y,0,t.x,t.y,r*3);
      g.addColorStop(0,'rgba(255,255,200,'+t.alpha+')');
      g.addColorStop(0.5,'rgba(201,166,70,'+(t.alpha*0.8)+')');
      g.addColorStop(1,'rgba(16,128,130,0)');
      cctx.fillStyle = g;
      cctx.beginPath();
      cctx.arc(t.x,t.y,r,0,Math.PI*2);
      cctx.fill();
      if(t.alpha < 0.02) trail.splice(i,1);
    }
    requestAnimationFrame(tickCursor);
  }
  requestAnimationFrame(tickCursor);
})();